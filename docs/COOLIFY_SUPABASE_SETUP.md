# Supabase Setup Guide for Coolify

This guide documents the complete setup process for self-hosting Supabase on Coolify and connecting it to a Next.js application.

**Last Updated:** 2025-12-18
**Tested With:** Coolify v4.0.0-beta.455, Supabase Kong 2.8.1, GoTrue v2.174.0

---

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Deploy Supabase in Coolify](#2-deploy-supabase-in-coolify)
3. [Configure Kong (API Gateway & CORS)](#3-configure-kong-api-gateway--cors)
4. [Configure Supabase Auth (GoTrue)](#4-configure-supabase-auth-gotrue)
5. [Configure SMTP for Emails](#5-configure-smtp-for-emails)
6. [Database Setup](#6-database-setup)
7. [Next.js Application Configuration](#7-nextjs-application-configuration)
8. [Testing the Setup](#8-testing-the-setup)
9. [Troubleshooting](#9-troubleshooting)

---

## 1. Prerequisites

Before starting, ensure you have:

- [ ] A Coolify instance running (self-hosted or cloud)
- [ ] A domain name pointing to your Coolify server
- [ ] SSL certificates configured (Coolify handles this automatically)
- [ ] A Next.js application ready to deploy
- [ ] SMTP credentials for sending emails (e.g., Privateemail, SendGrid, Mailgun)

### Domain Planning

You'll need to plan your domains:

| Service | Example Domain |
|---------|----------------|
| Supabase Kong (API) | `supabasekong-xxxxx.yourdomain.com` (auto-generated by Coolify) |
| Your Next.js App | `app.yourdomain.com` or `yourdomain.com` |

---

## 2. Deploy Supabase in Coolify

### 2.1 Create Supabase Service

1. In Coolify, go to **Projects** → Select your project
2. Click **+ New** → **Service**
3. Search for **Supabase** and select it
4. Click **Deploy**

Coolify will create multiple containers:
- `supabase-kong` - API Gateway
- `supabase-auth` - Authentication (GoTrue)
- `supabase-db` - PostgreSQL database
- `supabase-rest` - PostgREST API
- `supabase-studio` - Admin dashboard
- `supabase-storage` - File storage
- `supabase-realtime` - Real-time subscriptions
- And others...

### 2.2 Wait for Deployment

Wait for all services to show **Running (healthy)** status. This may take 2-5 minutes.

### 2.3 Note Your URLs and Keys

After deployment, note these values from the Coolify service page:

```
Kong URL: https://supabasekong-xxxxx.yourdomain.com
Anon Key: eyJhbGciOiJIUzI1NiIs... (SERVICE_SUPABASEANON_KEY)
Service Key: eyJhbGciOiJIUzI1NiIs... (SERVICE_SUPABASESERVICE_KEY)
JWT Secret: (SERVICE_PASSWORD_JWT)
```

### 2.4 Test Basic Connectivity

Open your Kong URL in a browser. You should see the Supabase Studio login page.

---

## 3. Configure Kong (API Gateway & CORS)

Kong handles all API routing and CORS. Without proper CORS configuration, your frontend cannot communicate with Supabase.

### 3.1 Access Kong Container Terminal

1. In Coolify, find your Supabase service
2. Locate **Supabase Kong** in the services list
3. Click **Terminal** tab at the top
4. Select the `supabase-kong` container

### 3.2 View Current Kong Configuration

```bash
cat /home/kong/kong.yml
```

### 3.3 Edit Kong Configuration

The Kong config file is mounted from the host. You need to edit it on the host system.

**Option A: Edit via Coolify Terminal (temporary)**

```bash
cat > /home/kong/temp.yml << 'EOF'
# Paste the entire kong.yml content here
EOF
```

**Option B: Edit the source file on your server**

SSH into your Coolify server and find the Supabase volumes:
```bash
cd /path/to/coolify/data/services/supabase-xxxxx/volumes/api/
nano kong.yml
```

### 3.4 Complete Kong Configuration

Replace your `kong.yml` with this configuration. **Replace `https://your-app-domain.com` with your actual Next.js app URL:**

```yaml
###
### Global Plugins (applies to all routes)
###
plugins:
  - name: cors
    config:
      origins:
        - https://your-app-domain.com
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - apikey
        - x-client-info
      exposed_headers:
        - Content-Length
        - Content-Range
      credentials: true
      max_age: 3600

  - name: key-auth
    config:
      hide_credentials: false

###
### API Routes
###
services:

  ## Open Auth routes
  - name: auth-v1-open
    url: http://supabase-auth:9999/verify
    routes:
      - name: auth-v1-open
        strip_path: true
        paths:
          - /auth/v1/verify

  - name: auth-v1-open-callback
    url: http://supabase-auth:9999/callback
    routes:
      - name: auth-v1-open-callback
        strip_path: true
        paths:
          - /auth/v1/callback

  - name: auth-v1-open-authorize
    url: http://supabase-auth:9999/authorize
    routes:
      - name: auth-v1-open-authorize
        strip_path: true
        paths:
          - /auth/v1/authorize

  ## Secure Auth routes
  - name: auth-v1
    _comment: 'GoTrue: /auth/v1/* -> http://supabase-auth:9999/*'
    url: http://supabase-auth:9999/
    routes:
      - name: auth-v1-all
        strip_path: true
        paths:
          - /auth/v1/
    plugins:
      - name: key-auth
        config:
          hide_credentials: false
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin
            - anon

  ## Secure REST routes
  - name: rest-v1
    _comment: 'PostgREST: /rest/v1/* -> http://supabase-rest:3000/*'
    url: http://supabase-rest:3000/
    routes:
      - name: rest-v1-all
        strip_path: true
        paths:
          - /rest/v1/
    plugins:
      - name: key-auth
        config:
          hide_credentials: true
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin
            - anon

  ## Secure GraphQL routes
  - name: graphql-v1
    _comment: 'PostgREST: /graphql/v1/* -> http://supabase-rest:3000/rpc/graphql'
    url: http://supabase-rest:3000/rpc/graphql
    routes:
      - name: graphql-v1-all
        strip_path: true
        paths:
          - /graphql/v1
    plugins:
      - name: key-auth
        config:
          hide_credentials: true
      - name: request-transformer
        config:
          add:
            headers:
              - Content-Profile:graphql_public
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin
            - anon

  ## Secure Realtime routes
  - name: realtime-v1-ws
    _comment: 'Realtime: /realtime/v1/* -> ws://realtime:4000/socket/*'
    url: http://realtime-dev:4000/socket
    protocol: ws
    routes:
      - name: realtime-v1-ws
        strip_path: true
        paths:
          - /realtime/v1/
    plugins:
      - name: key-auth
        config:
          hide_credentials: false
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin
            - anon

  - name: realtime-v1-rest
    _comment: 'Realtime: /realtime/v1/api/* -> http://realtime:4000/api/*'
    url: http://realtime-dev:4000/api
    protocol: http
    routes:
      - name: realtime-v1-rest
        strip_path: true
        paths:
          - /realtime/v1/api
    plugins:
      - name: key-auth
        config:
          hide_credentials: false
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin
            - anon

  ## Storage routes
  - name: storage-v1
    _comment: 'Storage: /storage/v1/* -> http://supabase-storage:5000/*'
    url: http://supabase-storage:5000/
    routes:
      - name: storage-v1-all
        strip_path: true
        paths:
          - /storage/v1/

  ## Edge Functions routes
  - name: functions-v1
    _comment: 'Edge Functions: /functions/v1/* -> http://supabase-edge-functions:9000/*'
    url: http://supabase-edge-functions:9000/
    routes:
      - name: functions-v1-all
        strip_path: true
        paths:
          - /functions/v1/

  ## Analytics routes
  - name: analytics-v1
    _comment: 'Analytics: /analytics/v1/* -> http://logflare:4000/*'
    url: http://supabase-analytics:4000/
    routes:
      - name: analytics-v1-all
        strip_path: true
        paths:
          - /analytics/v1/

  ## Secure Database routes
  - name: meta
    _comment: 'pg-meta: /pg/* -> http://supabase-meta:8080/*'
    url: http://supabase-meta:8080/
    routes:
      - name: meta-all
        strip_path: true
        paths:
          - /pg/
    plugins:
      - name: key-auth
        config:
          hide_credentials: false
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - admin

  ## Protected Dashboard
  - name: dashboard
    _comment: 'Studio: /* -> http://studio:3000/*'
    url: http://supabase-studio:3000/
    routes:
      - name: dashboard-all
        strip_path: true
        paths:
          - /
    plugins:
      - name: basic-auth
        config:
          hide_credentials: true
```

### 3.5 Restart Kong

In Coolify, click **Restart** on the Supabase Kong service.

### 3.6 Test CORS

Open browser developer tools and run this in the console (replace with your URLs):

```javascript
fetch('https://supabasekong-xxxxx.yourdomain.com/auth/v1/health', {
  headers: {
    'apikey': 'your-anon-key'
  }
}).then(r => r.json()).then(console.log)
```

You should see a health response without CORS errors.

---

## 4. Configure Supabase Auth (GoTrue)

GoTrue handles authentication, email verification, and password resets.

### 4.1 Access Auth Container Settings

1. In Coolify, find **Supabase Auth** in your Supabase service
2. Click **Settings**
3. Go to **Environment Variables**

### 4.2 Required Environment Variables

Add or update these environment variables:

```bash
# Site URL - Your Next.js application URL
GOTRUE_SITE_URL=https://your-app-domain.com

# Allowed redirect URLs (use wildcards)
GOTRUE_URI_ALLOW_LIST=https://your-app-domain.com/*,https://your-app-domain.com/auth/callback*

# External hosts allowed in email links
GOTRUE_MAILER_EXTERNAL_HOSTS=your-app-domain.com,supabasekong-xxxxx.yourdomain.com

# External API URL (Kong URL)
API_EXTERNAL_URL=https://supabasekong-xxxxx.yourdomain.com

# Email confirmation path
GOTRUE_MAILER_URLPATHS_CONFIRMATION=/auth/v1/verify
GOTRUE_MAILER_URLPATHS_INVITE=/auth/v1/verify
GOTRUE_MAILER_URLPATHS_RECOVERY=/auth/v1/verify
GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE=/auth/v1/verify
```

### 4.3 Restart Auth Service

Click **Restart** on the Supabase Auth container.

---

## 5. Configure SMTP for Emails

Without SMTP, Supabase cannot send verification emails.

### 5.1 SMTP Environment Variables

Add these to the **Supabase Auth** container:

```bash
GOTRUE_SMTP_HOST=mail.yourmailprovider.com
GOTRUE_SMTP_PORT=587
GOTRUE_SMTP_USER=your-smtp-username
GOTRUE_SMTP_PASS=your-smtp-password
GOTRUE_SMTP_SENDER_NAME=Your App Name
GOTRUE_SMTP_ADMIN_EMAIL=noreply@yourdomain.com

# Enable email authentication
GOTRUE_EXTERNAL_EMAIL_ENABLED=true
GOTRUE_MAILER_AUTOCONFIRM=false
```

**Important Port Notes:**
- Port `587` = SMTP with STARTTLS (recommended)
- Port `465` = SMTP with SSL
- Port `993` = IMAP (WRONG - do not use)
- Port `25` = Unencrypted SMTP (not recommended)

### 5.2 Restart Auth Service

Click **Restart** on the Supabase Auth container.

### 5.3 Test Email

Try signing up with a new email in your app. You should receive a verification email.

---

## 6. Database Setup

Your Next.js app needs a `public.users` table that syncs with Supabase's `auth.users`.

### 6.1 Access Supabase Studio

1. Open your Kong URL: `https://supabasekong-xxxxx.yourdomain.com`
2. Login with your admin credentials (from Coolify's service config)
3. Go to **SQL Editor**

### 6.2 Create Users Table

Run this SQL:

```sql
-- Create the public users table
CREATE TABLE IF NOT EXISTS public.users (
  id uuid PRIMARY KEY,
  email text UNIQUE NOT NULL,
  name text,
  role text DEFAULT 'user',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz,

  -- Extended fields
  tier_id uuid,
  tier_expires_at timestamptz,
  status text DEFAULT 'active',
  subscription_status text,

  -- Status tracking
  suspended_reason text,
  suspended_at timestamptz,
  suspended_by uuid,
  paused_reason text,
  paused_at timestamptz,
  paused_by uuid,
  disabled_reason text,
  disabled_at timestamptz,
  disabled_by uuid,

  -- Activity tracking
  last_login_at timestamptz,
  login_count integer DEFAULT 0,

  -- Profile
  profile_image_url text,
  bio text,
  website text
);

-- Enable RLS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
```

### 6.3 Create Auth Trigger

This trigger automatically creates a `public.users` record when someone signs up:

```sql
-- Create the trigger function
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, name, role, status)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', NULL),
    'user',
    'active'
  )
  ON CONFLICT (id) DO NOTHING;
  RETURN NEW;
EXCEPTION WHEN OTHERS THEN
  -- Log error but don't block signup
  RAISE WARNING 'handle_new_user failed: %', SQLERRM;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';

-- Create the trigger on auth.users
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

### 6.4 Create RLS Policies

```sql
-- Allow the trigger to insert users
DROP POLICY IF EXISTS "users_insert_system" ON public.users;
CREATE POLICY "users_insert_system" ON public.users
  FOR INSERT WITH CHECK (true);

-- Users can view their own record
DROP POLICY IF EXISTS "users_select_own" ON public.users;
CREATE POLICY "users_select_own" ON public.users
  FOR SELECT USING (id = (SELECT auth.uid()));

-- Users can update their own record
DROP POLICY IF EXISTS "users_update_own" ON public.users;
CREATE POLICY "users_update_own" ON public.users
  FOR UPDATE USING (id = (SELECT auth.uid()));
```

### 6.5 Test the Trigger

```sql
-- Check if trigger exists
SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';

-- Check if function exists
SELECT proname FROM pg_proc WHERE proname = 'handle_new_user';
```

---

## 7. Next.js Application Configuration

### 7.1 Environment Variables

Add these to your Next.js app in Coolify:

```bash
# Supabase connection
NEXT_PUBLIC_SUPABASE_URL=https://supabasekong-xxxxx.yourdomain.com
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Site URL (for auth callbacks)
NEXT_PUBLIC_SITE_URL=https://your-app-domain.com
```

### 7.2 Auth Callback Route

Create `/app/auth/callback/route.ts`:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const code = searchParams.get("code");
  const redirect = searchParams.get("redirect") || "/";

  // Use configured site URL to avoid 0.0.0.0 issues in containers
  const forwardedHost = request.headers.get("x-forwarded-host");
  const origin = process.env.NEXT_PUBLIC_SITE_URL
    || (forwardedHost ? `https://${forwardedHost}` : null)
    || new URL(request.url).origin;

  if (code) {
    const supabase = await createClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);

    if (!error) {
      return NextResponse.redirect(`${origin}${redirect}`);
    }
  }

  return NextResponse.redirect(`${origin}/login?error=Could not authenticate`);
}
```

### 7.3 Supabase Client Setup

Create `/lib/supabase/client.ts`:

```typescript
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

Create `/lib/supabase/server.ts`:

```typescript
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options });
          } catch (error) {
            // Handle cookies in Server Components
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: "", ...options });
          } catch (error) {
            // Handle cookies in Server Components
          }
        },
      },
    }
  );
}

export function createServiceClient() {
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      cookies: {
        get() { return undefined; },
        set() {},
        remove() {},
      },
    }
  );
}
```

### 7.4 Content Security Policy

If using CSP headers, ensure your middleware allows Supabase connections:

```typescript
// In your security headers config
"connect-src": [
  "'self'",
  "https://supabasekong-xxxxx.yourdomain.com",
  "wss://supabasekong-xxxxx.yourdomain.com",
],
"img-src": [
  "'self'",
  "data:",
  "blob:",
  "https://supabasekong-xxxxx.yourdomain.com",
],
```

---

## 8. Testing the Setup

### 8.1 Test Database Connection

In your app or Supabase Studio:

```sql
SELECT NOW();
```

### 8.2 Test Auth Signup

1. Go to your app's signup page
2. Enter a new email and password
3. Click signup
4. **Expected:** Success message, verification email sent

### 8.3 Test Email Verification

1. Check your email for verification link
2. Click the link
3. **Expected:** Redirected to `https://your-app-domain.com/auth/callback`
4. **Expected:** Logged in and redirected to your app

### 8.4 Test User Record Creation

In Supabase Studio SQL Editor:

```sql
-- Check auth.users
SELECT id, email, created_at FROM auth.users ORDER BY created_at DESC LIMIT 5;

-- Check public.users (should match)
SELECT id, email, created_at FROM public.users ORDER BY created_at DESC LIMIT 5;
```

### 8.5 Test Login

1. Logout
2. Login with the same credentials
3. **Expected:** Successful login, redirected to app

---

## 9. Troubleshooting

### CORS Errors

**Symptom:** `No 'Access-Control-Allow-Origin' header` errors in browser console

**Fix:**
1. Check Kong configuration has CORS plugin with your domain
2. Restart Kong container
3. Clear browser cache

### 500 Error on Signup

**Symptom:** Signup returns 500 Internal Server Error

**Fix:**
1. Check Supabase Auth logs in Coolify
2. Ensure `public.users` table exists
3. Ensure `handle_new_user` trigger function exists
4. Check for missing foreign key constraints

### Emails Not Sending

**Symptom:** Signup succeeds but no verification email received

**Fix:**
1. Verify SMTP port is `587` (not `993`)
2. Check SMTP credentials are correct
3. Check Auth container logs for SMTP errors
4. Ensure `GOTRUE_EXTERNAL_EMAIL_ENABLED=true`

### Redirect to 0.0.0.0:3000

**Symptom:** After email verification, redirected to `https://0.0.0.0:3000/...`

**Fix:**
1. Set `NEXT_PUBLIC_SITE_URL` in your Next.js app
2. Update auth callback route to use `NEXT_PUBLIC_SITE_URL`
3. Verify `GOTRUE_SITE_URL` is set correctly

### OTP Expired Errors

**Symptom:** `Email link is invalid or has expired` error

**Fix:**
1. Links expire after 24 hours by default
2. Request a new signup/verification
3. Check server time is correct (NTP sync)

### User Not Created in public.users

**Symptom:** User exists in `auth.users` but not in `public.users`

**Fix:**
1. Check trigger exists: `SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';`
2. Check function exists: `SELECT proname FROM pg_proc WHERE proname = 'handle_new_user';`
3. Manually sync:
```sql
INSERT INTO public.users (id, email, role, status)
SELECT id, email, 'user', 'active'
FROM auth.users
WHERE id NOT IN (SELECT id FROM public.users);
```

---

## Quick Reference

### Key URLs

| Service | URL Pattern |
|---------|-------------|
| Kong API | `https://supabasekong-xxxxx.yourdomain.com` |
| REST API | `https://supabasekong-xxxxx.yourdomain.com/rest/v1/` |
| Auth API | `https://supabasekong-xxxxx.yourdomain.com/auth/v1/` |
| Storage | `https://supabasekong-xxxxx.yourdomain.com/storage/v1/` |
| Realtime | `wss://supabasekong-xxxxx.yourdomain.com/realtime/v1/` |

### Key Environment Variables

| Variable | Container | Example Value |
|----------|-----------|---------------|
| `GOTRUE_SITE_URL` | supabase-auth | `https://your-app.com` |
| `GOTRUE_URI_ALLOW_LIST` | supabase-auth | `https://your-app.com/*` |
| `GOTRUE_MAILER_EXTERNAL_HOSTS` | supabase-auth | `your-app.com,supabasekong-xxx.com` |
| `API_EXTERNAL_URL` | supabase-auth | `https://supabasekong-xxx.com` |
| `NEXT_PUBLIC_SUPABASE_URL` | your-app | `https://supabasekong-xxx.com` |
| `NEXT_PUBLIC_SITE_URL` | your-app | `https://your-app.com` |
