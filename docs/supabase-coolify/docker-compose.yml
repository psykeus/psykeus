# =============================================================================
# Supabase Docker Compose for Coolify - Self-Contained Setup
# =============================================================================
#
# This is a complete, self-contained Supabase stack that requires minimal setup.
# All database initialization, configurations, and edge functions are included.
#
# =============================================================================
# REQUIRED CONFIGURATION (search and replace these values):
# =============================================================================
#
#   YOUR_APP_DOMAIN     - Your Next.js app domain (e.g., myapp.example.com)
#   YOUR_SUPABASE_DOMAIN - Kong API domain assigned by Coolify
#
# =============================================================================
# OPTIONAL CONFIGURATION (set in Coolify environment variables):
# =============================================================================
#
#   SMTP_HOST           - SMTP server hostname
#   SMTP_PORT           - SMTP port (default: 587)
#   SMTP_USER           - SMTP username
#   SMTP_PASS           - SMTP password
#   SMTP_SENDER_NAME    - Email sender name
#   SMTP_ADMIN_EMAIL    - Admin email address
#
# =============================================================================
# AUTO-GENERATED BY COOLIFY (do not set manually):
# =============================================================================
#
#   SERVICE_PASSWORD_JWT
#   SERVICE_PASSWORD_POSTGRES
#   SERVICE_SUPABASEANON_KEY
#   SERVICE_SUPABASESERVICE_KEY
#   SERVICE_USER_ADMIN
#   SERVICE_PASSWORD_ADMIN
#   SERVICE_USER_MINIO
#   SERVICE_PASSWORD_MINIO
#   SERVICE_PASSWORD_LOGFLARE
#   SECRET_PASSWORD_REALTIME
#   SERVICE_PASSWORD_SUPAVISORSECRET
#   SERVICE_PASSWORD_VAULTENC
#   SERVICE_URL_SUPABASEKONG
#
# =============================================================================

services:
  # ===========================================================================
  # Kong API Gateway
  # ===========================================================================
  # Routes all API requests and handles CORS
  # CORS is configured in volumes/api/kong.yml
  # ===========================================================================
  supabase-kong:
    image: 'kong:2.8.1'
    entrypoint: 'bash -c ''eval "echo \"$(cat ~/temp.yml)\"" > ~/kong.yml && /docker-entrypoint.sh kong docker-start'''
    depends_on:
      supabase-analytics:
        condition: service_healthy
    environment:
      - 'KONG_PORT_MAPS=443:8000'
      - 'JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/home/kong/kong.yml
      - 'KONG_DNS_ORDER=LAST,A,CNAME'
      - 'KONG_PLUGINS=request-transformer,cors,key-auth,acl,basic-auth'
      - KONG_NGINX_PROXY_PROXY_BUFFER_SIZE=160k
      - 'KONG_NGINX_PROXY_PROXY_BUFFERS=64 160k'
      - 'SUPABASE_ANON_KEY=${SERVICE_SUPABASEANON_KEY}'
      - 'SUPABASE_SERVICE_KEY=${SERVICE_SUPABASESERVICE_KEY}'
      - 'DASHBOARD_USERNAME=${SERVICE_USER_ADMIN}'
      - 'DASHBOARD_PASSWORD=${SERVICE_PASSWORD_ADMIN}'
    volumes:
      - type: bind
        source: ./volumes/api/kong.yml
        target: /home/kong/temp.yml
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Supabase Auth (GoTrue)
  # ===========================================================================
  # Handles user authentication, email verification, and OAuth
  # ===========================================================================
  supabase-auth:
    image: 'supabase/gotrue:v2.174.0'
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-analytics:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:9999/health"]
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      # API Configuration
      - GOTRUE_API_HOST=0.0.0.0
      - GOTRUE_API_PORT=9999
      # =========================================================================
      # CHANGE THIS: Your Supabase API URL (Kong domain)
      # =========================================================================
      - 'API_EXTERNAL_URL=https://YOUR_SUPABASE_DOMAIN'

      # Database
      - GOTRUE_DB_DRIVER=postgres
      - 'GOTRUE_DB_DATABASE_URL=postgres://supabase_auth_admin:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}'

      # =========================================================================
      # CHANGE THIS: Your Next.js App Domain
      # =========================================================================
      - 'GOTRUE_SITE_URL=https://YOUR_APP_DOMAIN'
      - 'GOTRUE_URI_ALLOW_LIST=https://YOUR_APP_DOMAIN/*,https://YOUR_APP_DOMAIN/auth/callback,https://YOUR_APP_DOMAIN/auth/callback/*'
      # =========================================================================
      # CHANGE THIS: Both domains (app + supabase) for email link validation
      # =========================================================================
      - 'GOTRUE_MAILER_EXTERNAL_HOSTS=YOUR_APP_DOMAIN,YOUR_SUPABASE_DOMAIN'

      # JWT Configuration
      - GOTRUE_JWT_ADMIN_ROLES=service_role
      - GOTRUE_JWT_AUD=authenticated
      - GOTRUE_JWT_DEFAULT_GROUP_NAME=authenticated
      - 'GOTRUE_JWT_EXP=${JWT_EXPIRY:-3600}'
      - 'GOTRUE_JWT_SECRET=${SERVICE_PASSWORD_JWT}'

      # Email Configuration
      - 'GOTRUE_EXTERNAL_EMAIL_ENABLED=true'
      - 'GOTRUE_EXTERNAL_ANONYMOUS_USERS_ENABLED=false'
      - 'GOTRUE_MAILER_AUTOCONFIRM=false'
      - 'GOTRUE_DISABLE_SIGNUP=false'

      # =========================================================================
      # SMTP Configuration - Set in Coolify Environment Variables
      # =========================================================================
      - 'GOTRUE_SMTP_HOST=${SMTP_HOST:-smtp.example.com}'
      - 'GOTRUE_SMTP_PORT=${SMTP_PORT:-587}'
      - 'GOTRUE_SMTP_USER=${SMTP_USER:-}'
      - 'GOTRUE_SMTP_PASS=${SMTP_PASS:-}'
      - 'GOTRUE_SMTP_SENDER_NAME=${SMTP_SENDER_NAME:-Your App}'
      - 'GOTRUE_SMTP_ADMIN_EMAIL=${SMTP_ADMIN_EMAIL:-noreply@example.com}'

      # Email URL Paths (verification links go through Kong)
      - 'GOTRUE_MAILER_URLPATHS_INVITE=/auth/v1/verify'
      - 'GOTRUE_MAILER_URLPATHS_CONFIRMATION=/auth/v1/verify'
      - 'GOTRUE_MAILER_URLPATHS_RECOVERY=/auth/v1/verify'
      - 'GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE=/auth/v1/verify'

      # Phone Auth (disabled by default)
      - 'GOTRUE_EXTERNAL_PHONE_ENABLED=false'
      - 'GOTRUE_SMS_AUTOCONFIRM=true'

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  # Main database with all Supabase extensions and schemas pre-configured
  # Initialization scripts in volumes/db/ run automatically on first start
  # ===========================================================================
  supabase-db:
    image: 'supabase/postgres:15.8.1.048'
    healthcheck:
      test: 'pg_isready -U postgres -h 127.0.0.1'
      interval: 5s
      timeout: 5s
      retries: 10
    depends_on:
      supabase-vector:
        condition: service_healthy
    command:
      - postgres
      - '-c'
      - config_file=/etc/postgresql/postgresql.conf
      - '-c'
      - log_min_messages=fatal
    environment:
      - POSTGRES_HOST=/var/run/postgresql
      - 'PGPORT=${POSTGRES_PORT:-5432}'
      - 'POSTGRES_PORT=${POSTGRES_PORT:-5432}'
      - 'PGPASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - 'POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - 'PGDATABASE=${POSTGRES_DB:-postgres}'
      - 'POSTGRES_DB=${POSTGRES_DB:-postgres}'
      - 'JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'JWT_EXP=${JWT_EXPIRY:-3600}'
    volumes:
      - 'supabase-db-data:/var/lib/postgresql/data'
      # Database initialization scripts (run in alphabetical order)
      # 00 - Core Supabase setup (roles, schemas, extensions, auth tables)
      - type: bind
        source: ./volumes/db/00-init-scripts.sql
        target: /docker-entrypoint-initdb.d/init-scripts/00-init-scripts.sql
      # 01 - Application users table and auth trigger
      - type: bind
        source: ./volumes/db/01-init-users.sql
        target: /docker-entrypoint-initdb.d/init-scripts/01-init-users.sql
      - 'supabase-db-config:/etc/postgresql-custom'

  # ===========================================================================
  # Supabase Studio
  # ===========================================================================
  # Web-based database management UI (protected by basic auth via Kong)
  # ===========================================================================
  supabase-studio:
    image: 'supabase/studio:2025.06.02-sha-8f2993d'
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:3000/api/platform/profile').then((r) => {if (r.status !== 200) throw new Error(r.status)})"]
      timeout: 5s
      interval: 5s
      retries: 3
    depends_on:
      supabase-analytics:
        condition: service_healthy
    environment:
      - HOSTNAME=0.0.0.0
      - 'STUDIO_PG_META_URL=http://supabase-meta:8080'
      - 'POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - 'DEFAULT_ORGANIZATION_NAME=${STUDIO_DEFAULT_ORGANIZATION:-Default Organization}'
      - 'DEFAULT_PROJECT_NAME=${STUDIO_DEFAULT_PROJECT:-Default Project}'
      - 'SUPABASE_URL=http://supabase-kong:8000'
      - 'SUPABASE_PUBLIC_URL=${SERVICE_URL_SUPABASEKONG}'
      - 'SUPABASE_ANON_KEY=${SERVICE_SUPABASEANON_KEY}'
      - 'SUPABASE_SERVICE_KEY=${SERVICE_SUPABASESERVICE_KEY}'
      - 'AUTH_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'LOGFLARE_API_KEY=${SERVICE_PASSWORD_LOGFLARE}'
      - 'LOGFLARE_URL=http://supabase-analytics:4000'
      - 'SUPABASE_PUBLIC_API=${SERVICE_URL_SUPABASEKONG}'
      - NEXT_PUBLIC_ENABLE_LOGS=true
      - NEXT_ANALYTICS_BACKEND_PROVIDER=postgres

  # ===========================================================================
  # PostgREST
  # ===========================================================================
  # Auto-generates REST API from PostgreSQL schema
  # ===========================================================================
  supabase-rest:
    image: 'postgrest/postgrest:v12.2.12'
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-analytics:
        condition: service_healthy
    environment:
      - 'PGRST_DB_URI=postgres://authenticator:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}'
      - 'PGRST_DB_SCHEMAS=${PGRST_DB_SCHEMAS:-public,storage,graphql_public}'
      - PGRST_DB_ANON_ROLE=anon
      - 'PGRST_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - PGRST_DB_USE_LEGACY_GUCS=false
      - 'PGRST_APP_SETTINGS_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'PGRST_APP_SETTINGS_JWT_EXP=${JWT_EXPIRY:-3600}'
    command: postgrest

  # ===========================================================================
  # Realtime
  # ===========================================================================
  # WebSocket server for real-time database subscriptions
  # ===========================================================================
  realtime-dev:
    image: 'supabase/realtime:v2.34.47'
    container_name: realtime-dev.supabase-realtime
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-analytics:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sSfL", "--head", "-o", "/dev/null", "-H", "Authorization: Bearer ${SERVICE_SUPABASEANON_KEY}", "http://127.0.0.1:4000/api/tenants/realtime-dev/health"]
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      - PORT=4000
      - 'DB_HOST=${POSTGRES_HOSTNAME:-supabase-db}'
      - 'DB_PORT=${POSTGRES_PORT:-5432}'
      - DB_USER=supabase_admin
      - 'DB_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - 'DB_NAME=${POSTGRES_DB:-postgres}'
      - 'DB_AFTER_CONNECT_QUERY=SET search_path TO _realtime'
      - DB_ENC_KEY=supabaserealtime
      - 'API_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - FLY_ALLOC_ID=fly123
      - FLY_APP_NAME=realtime
      - 'SECRET_KEY_BASE=${SECRET_PASSWORD_REALTIME}'
      - 'ERL_AFLAGS=-proto_dist inet_tcp'
      - ENABLE_TAILSCALE=false
      - "DNS_NODES=''"
      - RLIMIT_NOFILE=10000
      - APP_NAME=realtime
      - SEED_SELF_HOST=true
      - LOG_LEVEL=error
      - RUN_JANITOR=true
      - JANITOR_INTERVAL=60000
    command: "sh -c \"/app/bin/migrate && /app/bin/realtime eval 'Realtime.Release.seeds(Realtime.Repo)' && /app/bin/server\"\n"

  # ===========================================================================
  # Analytics (Logflare)
  # ===========================================================================
  # Collects and stores logs from all services
  # ===========================================================================
  supabase-analytics:
    image: 'supabase/logflare:1.4.0'
    healthcheck:
      test: ["CMD", "curl", "http://127.0.0.1:4000/health"]
      timeout: 5s
      interval: 5s
      retries: 10
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      - LOGFLARE_NODE_HOST=127.0.0.1
      - DB_USERNAME=supabase_admin
      - DB_DATABASE=_supabase
      - 'DB_HOSTNAME=${POSTGRES_HOSTNAME:-supabase-db}'
      - 'DB_PORT=${POSTGRES_PORT:-5432}'
      - 'DB_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - DB_SCHEMA=_analytics
      - 'LOGFLARE_API_KEY=${SERVICE_PASSWORD_LOGFLARE}'
      - LOGFLARE_SINGLE_TENANT=true
      - LOGFLARE_SINGLE_TENANT_MODE=true
      - LOGFLARE_SUPABASE_MODE=true
      - LOGFLARE_MIN_CLUSTER_SIZE=1
      - 'POSTGRES_BACKEND_URL=postgresql://supabase_admin:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/_supabase'
      - POSTGRES_BACKEND_SCHEMA=_analytics
      - LOGFLARE_FEATURE_FLAG_OVERRIDE=multibackend=true

  # ===========================================================================
  # Vector (Log Collection)
  # ===========================================================================
  # Aggregates Docker container logs and sends to Analytics
  # ===========================================================================
  supabase-vector:
    image: 'timberio/vector:0.28.1-alpine'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://supabase-vector:9001/health"]
      timeout: 5s
      interval: 5s
      retries: 3
    volumes:
      - type: bind
        source: ./volumes/logs/vector.yml
        target: /etc/vector/vector.yml
        read_only: true
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      - 'LOGFLARE_API_KEY=${SERVICE_PASSWORD_LOGFLARE}'
    command: ['--config', 'etc/vector/vector.yml']

  # ===========================================================================
  # Storage (MinIO + Storage API)
  # ===========================================================================
  # S3-compatible object storage for files and images
  # ===========================================================================
  supabase-minio:
    image: 'ghcr.io/coollabsio/minio:RELEASE.2025-10-15T17-29-55Z'
    environment:
      - 'MINIO_ROOT_USER=${SERVICE_USER_MINIO}'
      - 'MINIO_ROOT_PASSWORD=${SERVICE_PASSWORD_MINIO}'
    command: 'server --console-address ":9001" /data'
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 20s
      retries: 10
    volumes:
      - './volumes/storage:/data'

  # Creates the 'stub' bucket in MinIO on first startup
  minio-createbucket:
    image: minio/mc
    restart: 'no'
    environment:
      - 'MINIO_ROOT_USER=${SERVICE_USER_MINIO}'
      - 'MINIO_ROOT_PASSWORD=${SERVICE_PASSWORD_MINIO}'
    depends_on:
      supabase-minio:
        condition: service_healthy
    entrypoint: [/bin/sh, /entrypoint.sh]
    volumes:
      - type: bind
        source: ./entrypoint.sh
        target: /entrypoint.sh

  supabase-storage:
    image: 'supabase/storage-api:v1.14.6'
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-rest:
        condition: service_started
      imgproxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:5000/status"]
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      - SERVER_PORT=5000
      - SERVER_REGION=local
      - MULTI_TENANT=false
      - 'AUTH_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'DATABASE_URL=postgres://supabase_storage_admin:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}'
      - DB_INSTALL_ROLES=false
      - STORAGE_BACKEND=s3
      - STORAGE_S3_BUCKET=stub
      - 'STORAGE_S3_ENDPOINT=http://supabase-minio:9000'
      - STORAGE_S3_FORCE_PATH_STYLE=true
      - STORAGE_S3_REGION=us-east-1
      - 'AWS_ACCESS_KEY_ID=${SERVICE_USER_MINIO}'
      - 'AWS_SECRET_ACCESS_KEY=${SERVICE_PASSWORD_MINIO}'
      - UPLOAD_FILE_SIZE_LIMIT=524288000
      - UPLOAD_FILE_SIZE_LIMIT_STANDARD=524288000
      - UPLOAD_SIGNED_URL_EXPIRATION_TIME=120
      - TUS_URL_PATH=upload/resumable
      - TUS_MAX_SIZE=3600000
      - ENABLE_IMAGE_TRANSFORMATION=true
      - 'IMGPROXY_URL=http://imgproxy:8080'
      - IMGPROXY_REQUEST_TIMEOUT=15
      - DATABASE_SEARCH_PATH=storage
      - NODE_ENV=production
      - REQUEST_ALLOW_X_FORWARDED_PATH=true
    volumes:
      - './volumes/storage:/var/lib/storage'

  imgproxy:
    image: 'darthsim/imgproxy:v3.8.0'
    healthcheck:
      test: ["CMD", "imgproxy", "health"]
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      - IMGPROXY_LOCAL_FILESYSTEM_ROOT=/
      - IMGPROXY_USE_ETAG=true
      - 'IMGPROXY_ENABLE_WEBP_DETECTION=true'
    volumes:
      - './volumes/storage:/var/lib/storage'

  # ===========================================================================
  # Postgres Meta
  # ===========================================================================
  # Provides schema introspection for Studio
  # ===========================================================================
  supabase-meta:
    image: 'supabase/postgres-meta:v0.89.3'
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-analytics:
        condition: service_healthy
    environment:
      - PG_META_PORT=8080
      - 'PG_META_DB_HOST=${POSTGRES_HOSTNAME:-supabase-db}'
      - 'PG_META_DB_PORT=${POSTGRES_PORT:-5432}'
      - 'PG_META_DB_NAME=${POSTGRES_DB:-postgres}'
      - PG_META_DB_USER=supabase_admin
      - 'PG_META_DB_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'

  # ===========================================================================
  # Edge Functions
  # ===========================================================================
  # Deno-based serverless functions
  # ===========================================================================
  supabase-edge-functions:
    image: 'supabase/edge-runtime:v1.67.4'
    depends_on:
      supabase-analytics:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "echo", "Edge Functions is healthy"]
      timeout: 5s
      interval: 5s
      retries: 3
    environment:
      - 'JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'SUPABASE_URL=${SERVICE_URL_SUPABASEKONG}'
      - 'SUPABASE_ANON_KEY=${SERVICE_SUPABASEANON_KEY}'
      - 'SUPABASE_SERVICE_ROLE_KEY=${SERVICE_SUPABASESERVICE_KEY}'
      - 'SUPABASE_DB_URL=postgresql://postgres:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}'
      - 'VERIFY_JWT=false'
    volumes:
      - './volumes/functions:/home/deno/functions'
    command: ['start', '--main-service', '/home/deno/functions/main']

  # ===========================================================================
  # Supavisor (Connection Pooler)
  # ===========================================================================
  # Efficient PostgreSQL connection pooling
  # ===========================================================================
  supabase-supavisor:
    image: 'supabase/supavisor:2.5.1'
    healthcheck:
      test: ["CMD", "curl", "-sSfL", "-o", "/dev/null", "http://127.0.0.1:4000/api/health"]
      timeout: 5s
      interval: 5s
      retries: 10
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-analytics:
        condition: service_healthy
    environment:
      - POOLER_TENANT_ID=dev_tenant
      - POOLER_POOL_MODE=transaction
      - 'POOLER_DEFAULT_POOL_SIZE=${POOLER_DEFAULT_POOL_SIZE:-20}'
      - 'POOLER_MAX_CLIENT_CONN=${POOLER_MAX_CLIENT_CONN:-100}'
      - PORT=4000
      - 'POSTGRES_PORT=${POSTGRES_PORT:-5432}'
      - 'POSTGRES_HOSTNAME=${POSTGRES_HOSTNAME:-supabase-db}'
      - 'POSTGRES_DB=${POSTGRES_DB:-postgres}'
      - 'POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}'
      - 'DATABASE_URL=ecto://supabase_admin:${SERVICE_PASSWORD_POSTGRES}@${POSTGRES_HOSTNAME:-supabase-db}:${POSTGRES_PORT:-5432}/_supabase'
      - CLUSTER_POSTGRES=true
      - 'SECRET_KEY_BASE=${SERVICE_PASSWORD_SUPAVISORSECRET}'
      - 'VAULT_ENC_KEY=${SERVICE_PASSWORD_VAULTENC}'
      - 'API_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - 'METRICS_JWT_SECRET=${SERVICE_PASSWORD_JWT}'
      - REGION=local
      - 'ERL_AFLAGS=-proto_dist inet_tcp'
    command: ['/bin/sh', '-c', '/app/bin/migrate && /app/bin/supavisor eval "$(cat /etc/pooler/pooler.exs)" && /app/bin/server']
    volumes:
      - type: bind
        source: ./volumes/pooler/pooler.exs
        target: /etc/pooler/pooler.exs

# =============================================================================
# Volumes
# =============================================================================
volumes:
  supabase-db-data:
  supabase-db-config:
